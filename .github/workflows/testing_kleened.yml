name: Run Kleened and Klee test suites

on:
  push:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    name: Running Kleened and Klee test-suites
    steps:
    - uses: actions/checkout@v4
    - name: Run tests in a FreeBSD VM
      id: kleened-testing
      # FreeBSD 14.1-RELEASE
      uses: vmactions/freebsd-vm@v1.1.5
      with:
        usesh: true
    - name: Configure the FreeBSD vm
      shell: freebsd {0}
      run: |
        ###### Configure ZFS ######
        kldload zfs
        sysrc -f /boot/loader.conf zfs_load="YES"
        sysrc zfs_enable="YES"
        truncate -s 10G /home/runner/zpool.disk
        zpool create -O atime=off -f zroot /home/runner/zpool.disk
        ###### Configure PF ######
        kldload pf.ko
        kldload pflog.ko
        kldload if_bridge
        sysrc pf_enable="YES"
        sysrc pflog_enable="YES"
        service pf start
        service pflog start
        # To make all networking-tests pass:
        sysctl net.link.bridge.pfil_bridge=1

        ###### Create basejail ######
        fetch https://download.freebsd.org/releases/amd64/14.1-RELEASE/base.txz
        zfs create zroot/kleene_basejail
        tar -xf base.txz -C /zroot/kleene_basejail

    - name: Build Kleened and run its testsuite
      shell: freebsd {0}
      run: |
        ##### Configure and run Kleened Tests
        cd $GITHUB_WORKSPACE;
        mkdir -p /usr/local/etc/kleened
        cp example/kleened_config_dev.yaml /usr/local/etc/kleened/config.yaml
        cp -r test/data/test_certs /usr/local/etc/kleened/certs
        cp example/pf.conf.dev.kleene /usr/local/etc/kleened/pf.conf.kleene

        pkg install -y elixir git gmake ca_root_nss
        mix local.rebar --force
        mix local.hex --force
        make init
        #make test
        #mix run -e "Kleened.Core.Image.remove(\"FreeBSD:testing\")"
        ##### Install & Start Kleened
        MIX_ENV=dev
        mix release
        ln -s ./priv/bin/kleened_pty /usr/local/sbin/kleened_pty
        _build/dev/rel/kleened/bin/kleened daemon

        
        ##### Run Klee-tests
        git clone -b ${{ github.ref_type == 'branch' && github.ref_name || 'main' }} https://github.com/kleene-project/klee.git
        pkg install -y py311-poetry > /dev/null
        cd klee
        poetry install
        poetry run pytest -vv -x -k test_build_remove_and_list_images

    - name: Show Kleened-logs
      if: always()
      shell: freebsd {0}
      run: cat /var/log/kleened.log
